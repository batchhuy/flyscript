-- SETTINGS
local DOUBLE_TAP_TIME = 0.3
local SPEED_MULTIPLIER = 5

-- SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- PLAYER
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")

-- VARIABLES
local flying = false
local lastJump = 0
local attachment
local linearVelocity
local alignOrientation
local flyConnection

-- GUI VARIABLES
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AdminPanel"
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 100)
frame.Position = UDim2.new(0.5, -100, 0.5, -50)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = screenGui

-- Optional: add a label to show instructions
local label = Instance.new("TextLabel")
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.Text = "Double Tap Space to Fly\nDrag to Move GUI"
label.TextScaled = true
label.Parent = frame

-- FUNCTIONS

-- START FLYING
local function startFlying()
	if flying then return end
	flying = true

	humanoid:ChangeState(Enum.HumanoidStateType.Physics)
	humanoid.AutoRotate = false

	attachment = Instance.new("Attachment")
	attachment.Parent = root

	linearVelocity = Instance.new("LinearVelocity")
	linearVelocity.Attachment0 = attachment
	linearVelocity.RelativeTo = Enum.ActuatorRelativeTo.World
	linearVelocity.MaxForce = math.huge
	linearVelocity.Parent = root

	alignOrientation = Instance.new("AlignOrientation")
	alignOrientation.Attachment0 = attachment
	alignOrientation.MaxTorque = math.huge
	alignOrientation.Responsiveness = 200
	alignOrientation.Parent = root

	local speed = humanoid.WalkSpeed * SPEED_MULTIPLIER

	flyConnection = RunService.RenderStepped:Connect(function()
		local look = camera.CFrame.LookVector
		linearVelocity.VectorVelocity = look * speed
		alignOrientation.CFrame = camera.CFrame
	end)
end

-- STOP FLYING
local function stopFlying()
	if not flying then return end
	flying = false

	if flyConnection then
		flyConnection:Disconnect()
		flyConnection = nil
	end

	if linearVelocity then linearVelocity:Destroy() linearVelocity = nil end
	if alignOrientation then alignOrientation:Destroy() alignOrientation = nil end
	if attachment then attachment:Destroy() attachment = nil end

	humanoid.AutoRotate = true
	humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
end

-- DOUBLE TAP SPACE DETECTION
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode ~= Enum.KeyCode.Space then return end

	local now = tick()
	if now - lastJump <= DOUBLE_TAP_TIME then
		if flying then
			stopFlying()
		else
			startFlying()
		end
	end
	lastJump = now
end)

-- RESPAWN FIX
player.CharacterAdded:Connect(function(char)
	character = char
	humanoid = char:WaitForChild("Humanoid")
	root = char:WaitForChild("HumanoidRootPart")
	stopFlying()
end)

-- DRAGGABLE GUI (HOLD TO DRAG)
local dragging = false
local dragStart
local startPos

local function update(input)
	local delta = input.Position - dragStart
	frame.Position = UDim2.new(
		startPos.X.Scale,
		startPos.X.Offset + delta.X,
		startPos.Y.Scale,
		startPos.Y.Offset + delta.Y
	)
end

frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = frame.Position

		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

frame.InputChanged:Connect(function(input)
	if dragging and (
		input.UserInputType == Enum.UserInputType.MouseMovement
		or input.UserInputType == Enum.UserInputType.Touch
	) then
		update(input)
	end
end)

